# 商品推荐系统实现文档

## 系统架构概述

本推荐系统采用"实时数据捕捉 + 离线计算 + 在线服务"的专业架构：

- **实时数据捕捉**：使用Redis高性能记录用户浏览行为
- **离线计算**：定时任务运行协同过滤算法计算商品相似度
- **在线服务**：从Redis缓存中快速提供推荐结果

## 核心组件

### 1. 数据层 (Redis)

#### 用户浏览历史
- **Key**: `history:user:{userId}`
- **类型**: Sorted Set (有序集合)
- **Member**: productId
- **Score**: 浏览时间戳
- **用途**: 自动去重、按时间排序、限制数量

#### 用户兴趣画像
- **Key**: `profile:user:{userId}`
- **类型**: Hash (哈希表)
- **Field**: 标签名称 (如 "编程", "Java")
- **Value**: 兴趣分数 (浏览次数)

#### 商品推荐结果
- **Key**: `recommend:item-cf:{productId}`
- **类型**: Sorted Set
- **Member**: 相似商品ID
- **Score**: 相似度分数

### 2. 服务层

#### HistoryService
负责实时记录和查询用户行为数据：

```java
// 记录用户浏览
recordView(userId, productId)

// 获取用户历史
getUserHistory(userId, limit)

// 获取用户兴趣画像
getUserInterestProfile(userId, topN)
```

#### RecommendationEngineService
负责离线计算推荐结果：

```java
// 定时任务 - 每天凌晨3点执行
@Scheduled(cron = "0 0 3 * * ?")
computeRecommendations()

// 获取相似商品
getSimilarProducts(productId, limit)
```

### 3. 控制器层

#### HistoryController
提供浏览行为追踪API：

- `POST /api/history/view` - 记录商品浏览
- `GET /api/history/my-history` - 获取我的浏览历史
- `GET /api/history/my-interests` - 获取我的兴趣画像

#### RecommendationController
提供推荐服务API：

- `GET /api/recommendations/for-you` - 个性化推荐(猜你喜欢)
- `GET /api/recommendations/products/{id}/similar` - 相似商品推荐
- `POST /api/recommendations/compute` - 手动触发计算(管理员)

## 算法实现

### 基于物品的协同过滤算法

1. **构建共现矩阵**
   ```
   遍历所有用户的浏览历史
   统计商品对的共同浏览次数
   ```

2. **计算相似度**
   ```
   使用余弦相似度公式：
   Similarity(A,B) = CoOccurrence(A,B) / sqrt(TotalViews(A) * TotalViews(B))
   ```

3. **存储结果**
   ```
   为每个商品存储Top 10相似商品
   按相似度分数排序存入Redis
   ```

## 前端集成

### 数据追踪
在ProductDetail.vue中自动追踪用户浏览：
```javascript
// 用户访问商品详情页时自动调用
trackProductView() // 发送到 POST /api/history/view
```

### 推荐展示

#### 首页 - "猜你喜欢"
```vue
<RecommendationSection
  title="🎯 猜你喜欢"
  subtitle="基于您的浏览历史和兴趣"
  :products="recommendedProducts"
/>
```

#### 商品详情页 - "看了又看"
```vue
<RecommendationSection
  title="👀 看了又看"
  subtitle="其他用户也浏览过这些商品"
  :products="similarProducts"
/>
```

## 性能优化

### Redis优化
- 使用Sorted Set自动排序和去重
- 限制用户历史记录数量(最多100条)
- 定期清理过期数据

### 计算优化
- 离线计算避免实时性能影响
- 只存储Top N推荐结果
- 批量处理提高效率

### 容错设计
- 推荐功能失败不影响主要业务
- 提供分类推荐作为fallback
- 匿名用户显示热门商品

## 部署和配置

### Redis配置
确保docker-compose.yml中包含Redis服务：
```yaml
redis-cache:
  image: redis:7-alpine
  ports:
    - "6379:6379"
```

### Spring Boot配置
```properties
# Redis连接配置
spring.data.redis.host=localhost
spring.data.redis.port=6379
spring.data.redis.database=0
```

### 定时任务
系统自动启用@EnableScheduling，推荐计算每天自动执行。

## 监控和维护

### 数据监控
- 用户浏览量统计
- 推荐点击率分析
- Redis内存使用情况

### 性能调优
- 根据用户量调整历史记录保留数量
- 优化相似度计算算法
- 调整推荐更新频率

## 扩展功能

### 未来可扩展特性
1. 基于用户的协同过滤
2. 内容推荐(标签匹配)
3. 热度加权推荐
4. A/B测试框架
5. 实时推荐更新

### 数据分析
1. 推荐效果评估
2. 用户行为分析
3. 商品流行度分析
4. 转化率统计

## 故障排除

### 常见问题
1. **Redis连接失败**: 检查Redis服务状态和连接配置
2. **推荐结果为空**: 检查是否有足够的用户浏览数据
3. **计算任务失败**: 查看定时任务日志

### 调试方法
1. 检查Redis中的数据结构
2. 验证API响应
3. 查看应用日志
4. 使用Redis CLI工具调试

这个推荐系统为您的二手交易平台提供了企业级的个性化推荐能力，能够显著提升用户体验和商品发现效率。
