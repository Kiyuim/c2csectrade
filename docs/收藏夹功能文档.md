# 收藏夹功能文档

## 功能概述

收藏夹功能允许用户保存他们感兴趣的商品，以便将来快速查找和访问。用户可以随时将商品加入收藏夹，也可以随时取消收藏。这是一个轻量级的商品跟踪功能，旨在提升用户的回访率和购物体验。

### 核心功能
- **添加收藏**：在商品详情页，用户可以点击“收藏”按钮（通常是一个心形图标），将商品加入个人收藏夹。
- **取消收藏**：用户可以再次点击同一个按钮来取消收藏，或者在收藏夹列表中进行移除操作。
- **查看收藏列表**：用户可以通过个人中心的入口或全局悬浮按钮访问自己的收藏夹页面，查看所有已收藏的商品。
- **状态同步**：商品详情页的收藏按钮会实时反映当前商品是否已被用户收藏。

## 数据库表结构

### favorite表（收藏表）
```sql
CREATE TABLE `favorite` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '收藏ID',
  `user_id` int NOT NULL COMMENT '用户ID',
  `product_id` int NOT NULL COMMENT '商品ID',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_product` (`user_id`,`product_id`) COMMENT '确保用户对同一商品只能收藏一次',
  KEY `user_id` (`user_id`),
  KEY `product_id` (`product_id`),
  CONSTRAINT `favorite_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`),
  CONSTRAINT `favorite_ibfk_2` FOREIGN KEY (`product_id`) REFERENCES `product` (`id`)
);
```

## 后端API接口

#### 1. 添加商品到收藏夹
`POST /api/favorites`
- **Authorization**: `Bearer {token}`
- **Request Body**: `{ "productId": 123 }`
- **Response**: 成功或失败的消息。

#### 2. 从收藏夹移除商品
`DELETE /api/favorites/{productId}`
- **Authorization**: `Bearer {token}`
- **Response**: 成功或失败的消息。

#### 3. 获取用户的收藏列表
`GET /api/favorites`
- **Authorization**: `Bearer {token}`
- **Response**: 返回一个包含用户收藏的所有商品信息的列表。

#### 4. 检查商品是否已被收藏
`GET /api/favorites/status/{productId}`
- **Authorization**: `Bearer {token}`
- **Response**: `{ "isFavorited": true }` 或 `{ "isFavorited": false }`。

## 前端视图与组件

- **FavoritesView.vue**: 用户的个人收藏夹页面。
  - 路由: `/favorites`
  - 功能：
    - 以卡片或列表形式展示所有已收藏的商品。
    - 每个商品项都包含图片、标题、价格等基本信息。
    - 提供“取消收藏”按钮或直接点击商品跳转到详情页的链接。

- **FloatingFavoritesButton.vue**: 全局悬浮收藏夹按钮。
  - 在大多数页面显示，作为访问收藏夹的快捷入口。
  - 点击后导航到 `/favorites` 页面。

- **商品详情页中的收藏按钮**:
  - 通常在 `ProductDetail.vue` 中实现。
  - 是一个可以切换状态的按钮（例如，空心/实心图标）。
  - 页面加载时，会调用 `GET /api/favorites/status/{productId}` 接口来确定其初始状态。

## 使用流程

1. 用户登录后，进入任意一个商品详情页 (`ProductDetail.vue`)。
2. 页面加载时，会（并行地）调用 `GET /api/products/{productId}` 获取商品信息，并调用 `GET /api/favorites/status/{productId}` 检查该商品是否已被当前用户收藏。
3. 根据接口返回的 `isFavorited` 状态，收藏按钮（心形图标）显示为“已收藏”（实心）或“未收藏”（空心）。
4. 用户点击收藏按钮：
   - 如果当前是“未收藏”状态，前端调用 `POST /api/favorites` 接口。成功后，按钮状态切换为“已收藏”。
   - 如果当前是“已收藏”状态，前端调用 `DELETE /api/favorites/{productId}` 接口。成功后，按钮状态切换为“未收藏”。
5. 用户可以通过 `FloatingFavoritesButton.vue` 或其他入口访问 `/favorites` 页面。
6. `FavoritesView.vue` 在加载时调用 `GET /api/favorites` 接口，获取完整的收藏列表并渲染。
7. 在收藏夹页面，用户可以浏览商品或执行取消收藏操作。

## 核心功能实现

### 后端
- **Favorite.java**: 收藏记录的实体类。
- **FavoriteMapper.java**: MyBatis Mapper接口，用于数据库操作。
- **FavoriteService.java**: 业务逻辑核心，实现了添加、删除、查询收藏等功能。其中，添加和删除操作都需要校验操作者是否为本人。
- **FavoriteController.java**: 暴露给前端的RESTful API接口。

### 前端
- **状态管理**: 在 `ProductDetail.vue` 中，通常会有一个本地的状态变量，如 `isFavorited` (ref或data)，用于控制收藏按钮的显示样式。
- **API调用**: 收藏和取消收藏的操作是直接的API调用，不需要像购物车那样复杂的本地状态管理（如商品数量）。
- **用户体验**: 为了提升用户体验，点击收藏按钮后，前端应立即更新UI状态（“乐观更新”），然后再等待API的返回。如果API调用失败，再将UI状态回滚，并给出错误提示。
