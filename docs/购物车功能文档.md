# 购物车功能文档

## 功能概述

购物车功能为用户提供了一个临时的商品存储区，方便用户批量管理和结算感兴趣的商品。用户可以将多个不同卖家的商品加入购物车，统一查看、管理数量，并最终生成订单进行支付。

### 核心功能
- **添加商品到购物车**：在商品详情页，用户可以点击“加入购物车”按钮，将当前商品添加进去。
- **查看购物车**：用户可以通过悬浮的购物车按钮或导航入口进入购物车页面，查看所有已添加的商品。
- **修改商品数量**：在购物车页面，用户可以增加或减少计划购买的商品数量。
- **移除商品**：用户可以从购物车中删除单个或多个商品。
- **批量结算**：用户可以选择购物车中的部分或全部商品，进行合并结算，生成一个或多个订单。
- **角标提示**：悬浮的购物车按钮会实时显示购物车中商品的种类数量。

## 数据库表结构

### cart_item表（购物车项目表）
```sql
CREATE TABLE `cart_item` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '购物车项目ID',
  `user_id` int NOT NULL COMMENT '用户ID',
  `product_id` int NOT NULL COMMENT '商品ID',
  `quantity` int NOT NULL DEFAULT '1' COMMENT '数量',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `user_id` (`user_id`),
  KEY `product_id` (`product_id`),
  CONSTRAINT `cart_item_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`),
  CONSTRAINT `cart_item_ibfk_2` FOREIGN KEY (`product_id`) REFERENCES `product` (`id`)
);
```
*注：为了保证唯一性，通常还会对 `(user_id, product_id)` 创建一个唯一索引，防止同一商品被多次插入。如果已存在，则应更新其 `quantity`。*

## 后端API接口

#### 1. 将商品加入购物车
`POST /api/cart/items`
- **Authorization**: `Bearer {token}`
- **Request Body**: `{ "productId": 123, "quantity": 1 }`
- **Response**: 成功或失败的消息，以及更新后的购物车商品总数。

#### 2. 获取用户的购物车内容
`GET /api/cart/items`
- **Authorization**: `Bearer {token}`
- **Response**: 返回一个包含用户购物车中所有商品详细信息的列表。

#### 3. 更新购物车中商品的数量
`PUT /api/cart/items/{cartItemId}`
- **Authorization**: `Bearer {token}`
- **Request Body**: `{ "quantity": 3 }`
- **Response**: 更新后的购物车项信息。

#### 4. 从购物车移除商品
`DELETE /api/cart/items/{cartItemId}`
- **Authorization**: `Bearer {token}`
- **Response**: 成功或失败的消息。

#### 5. 批量从购物车移除商品
`DELETE /api/cart/items`
- **Authorization**: `Bearer {token}`
- **Request Body**: `{ "cartItemIds": [1, 2, 3] }`
- **Response**: 成功或失败的消息。

## 前端视图与组件

- **CartView.vue**: 购物车主页面。
  - 路由: `/cart`
  - 功能：
    - 以列表形式展示购物车中的所有商品，按卖家进行分组。
    - 提供复选框，用于选择要结算或删除的商品。
    - 提供数量修改器（`+/-`按钮）。
    - 显示选中商品的总金额。
    - 提供“结算”和“删除”按钮。

- **FloatingCartButton.vue**: 全局悬浮购物车按钮。
  - 在大多数页面都会显示（通常在 `App.vue` 中全局注册）。
  - 显示一个购物车图标和一个角标，角标数字代表购物车中不同商品的总数。
  - 点击后导航到 `/cart` 页面。

## 使用流程

1. 用户在 `ProductDetail.vue` 页面点击“加入购物车”按钮。
2. 前端触发一个action（例如Vuex中的 `addToCart`），调用 `POST /api/cart/items` 接口。
3. 后端服务 `CartService.java` 处理请求：
   - 检查该用户的购物车中是否已存在此商品。
   - 如果存在，则增加其 `quantity`。
   - 如果不存在，则在 `cart_item` 表中插入一条新记录。
4. 接口返回成功后，前端可以更新UI，例如显示“添加成功”的提示，并更新 `FloatingCartButton.vue` 上的角标。
5. 用户点击悬浮按钮或通过其他入口进入 `/cart` 页面 (`CartView.vue`)。
6. `CartView.vue` 在加载时调用 `GET /api/cart/items` 接口，获取购物车内所有商品的数据并渲染列表。
7. 用户在购物车页面进行修改数量、勾选商品、删除等操作，这些操作会分别调用对应的后端API来同步数据库中的数据。
8. 用户点击“结算”后，前端将所有选中的 `cartItemIds` 传递给创建订单的页面（`PaymentView.vue`），并从购物车页面跳转过去。

## 核心功能实现

### 后端
- **CartItem.java**: 购物车项目的实体类。
- **CartItemMapper.java**: MyBatis Mapper接口，用于数据库操作。
- **CartService.java**: 业务逻辑核心，实现了添加、查询、更新、删除购物车项目等功能。
- **CartController.java**: 暴露给前端的RESTful API接口。

### 前端
- **Vuex Store (例如 `cart.js` 模块)**: 可以选择使用Vuex来管理购物车的状态，例如商品数量 `cartItemCount`。
  - `fetchCartItemCount` action: 在应用初始化或用户登录后调用，从后端获取购物车商品数量，用于更新悬浮按钮角标。
  - `addToCart` action: 添加商品时调用，与后端API交互后，如果成功则增加 `cartItemCount`。
- **状态管理**: 购物车页面 (`CartView.vue`) 的状态（如商品列表、选中状态、总价等）通常由组件自身的 `data` 或 `ref` (Composition API) 管理，因为这些状态主要局限于该页面。
- **按卖家分组**: 在 `CartView.vue` 中，获取到扁平的商品列表后，可以通过计算属性（`computed`）或一个方法将其处理成按 `sellerId` 或 `sellerName` 分组的树形结构，以便于在模板中渲染。
