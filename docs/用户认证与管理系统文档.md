# 用户认证与管理系统文档

## 功能概述

本系统为平台提供了完整的用户生命周期管理功能，包括用户认证和后台管理两大部分。

### 1. 用户认证
- **用户注册**：新用户可以通过邮箱和密码进行注册。
- **用户登录**：已注册用户可以使用邮箱和密码登录，系统会返回JWT令牌用于后续认证。
- **忘记密码**：用户可以通过注册邮箱找回密码。
- **退出登录**：用户可以清除本地认证信息，安全退出。
- **JWT认证**：系统使用JWT (JSON Web Token) 进行无状态认证，保护API接口。

### 2. 后台管理
- **用户查询**：管理员可以查看所有用户的列表，包括其基本信息和角色。
- **用户封禁/解封**：管理员可以禁用或启用某个用户账户。
- **角色管理**：管理员可以为用户分配不同的角色（如 `admin`, `user`）。

## 数据库表结构

### user表（用户表）
```sql
CREATE TABLE `user` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password` varchar(255) NOT NULL COMMENT '密码',
  `email` varchar(100) NOT NULL COMMENT '邮箱',
  `avatar` varchar(255) DEFAULT NULL COMMENT '头像URL',
  `balance` decimal(10,2) DEFAULT '0.00' COMMENT '余额',
  `payment_password` varchar(255) DEFAULT NULL COMMENT '支付密码',
  `is_enabled` tinyint(1) DEFAULT '1' COMMENT '是否启用',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `username` (`username`),
  UNIQUE KEY `email` (`email`)
);
```

### role表（角色表）
```sql
CREATE TABLE `role` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL,
  PRIMARY KEY (`id`)
);
```

### user_role表（用户角色关联表）
```sql
CREATE TABLE `user_role` (
  `user_id` int NOT NULL,
  `role_id` int NOT NULL,
  PRIMARY KEY (`user_id`,`role_id`),
  KEY `role_id` (`role_id`),
  CONSTRAINT `user_role_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`),
  CONSTRAINT `user_role_ibfk_2` FOREIGN KEY (`role_id`) REFERENCES `role` (`id`)
);
```

## 后端API接口

### 认证相关接口

#### 1. 用户注册
`POST /api/auth/register`
- **Request Body**: `{ "username": "testuser", "password": "password123", "email": "test@example.com" }`
- **Response**: 成功或失败的消息。

#### 2. 用户登录
`POST /api/auth/login`
- **Request Body**: `{ "username": "testuser", "password": "password123" }`
- **Response**: `{ "success": true, "token": "jwt-token-string", "user": { ... } }`

#### 3. 忘记密码
`POST /api/auth/forgot-password`
- **Request Body**: `{ "email": "test@example.com" }`
- **Response**: 发送密码重置邮件的确认消息。

### 后台管理接口

#### 1. 获取所有用户
`GET /api/admin/users`
- **Authorization**: `Bearer {admin-token}`
- **Response**: 返回包含所有用户信息的列表。

#### 2. 切换用户状态（封禁/解封）
`PUT /api/admin/users/{userId}/toggle-status`
- **Authorization**: `Bearer {admin-token}`
- **Response**: 成功或失败的消息。

## 前端视图与组件

### 认证视图
- **RegisterView.vue**: 用户注册页面，包含输入用户名、邮箱、密码的表单。
  - 路由: `/register`
- **LoginView.vue**: 用户登录页面，包含输入用户名/邮箱和密码的表单。
  - 路由: `/login`
- **ForgotPasswordView.vue**: 忘记密码页面，用于输入注册邮箱以接收重置链接。
  - 路由: `/forgot-password`

### 后台管理视图
- **AdminUsers.vue**: 管理员专用的用户管理页面。
  - 路由: `/admin/users`
  - 功能: 展示用户列表，提供搜索、封禁/解封用户的操作按钮。

### 核心逻辑文件
- **frontend/src/store/auth.js**: Vuex模块，用于管理用户的登录状态、token和用户信息。
- **frontend/src/router/index.js**: 路由配置文件，包含路由守卫，用于检查用户是否登录以及是否拥有管理员权限。

## 使用流程

### 用户认证流程
1. 新用户访问 `/register` 页面，填写信息完成注册。
2. 已注册用户访问 `/login` 页面，输入凭据登录。
3. 登录成功后，Vuex `auth.js` 存储token和用户信息，并将其保存到 `localStorage`。
4. 应用的HTTP客户端（如axios）在每个请求的 `Header` 中自动附加 `Authorization: Bearer {token}`。
5. 用户访问需要登录的页面时，路由守卫会检查 `auth.js` 中的登录状态，未登录则重定向到登录页。
6. 用户点击“退出登录”，`auth.js` 清除 `state` 和 `localStorage` 中的认证信息。

### 后台管理流程
1. 管理员用户登录系统。
2. 访问 `/admin/users` 页面。
3. 路由守卫检查用户是否拥有 `admin` 角色，没有则拒绝访问。
4. 页面加载时，调用 `GET /api/admin/users` 获取所有用户数据并展示。
5. 管理员可以点击按钮对特定用户执行封禁或解封操作。

## 核心功能实现

### 后端
- **SecurityConfig.java**: Spring Security的核心配置类，定义了认证逻辑、密码编码器（BCrypt）、JWT过滤器以及哪些URL需要保护。
- **JwtTokenProvider.java**: 用于生成和验证JWT令牌的工具类。
- **UserDetailsServiceImpl.java**: 实现Spring Security的 `UserDetailsService` 接口，用于根据用户名从数据库加载用户信息。
- **AuthController.java**: 处理注册、登录等认证请求的控制器。
- **AdminController.java**: 处理管理员相关操作的控制器。

### 前端
- **Vuex (auth.js)**:
  - `state`: 存储 `token`, `user`, `isAuthenticated`。
  - `mutations`: 定义修改 `state` 的同步方法，如 `SET_USER`, `LOGOUT`。
  - `actions`: 定义登录、注册、退出等异步操作，它们会调用API并提交 `mutations`。
- **Router Guards (router/index.js)**:
  - `beforeEach`: 全局前置守卫，在每次路由跳转前执行。
  - 检查 `meta.requiresAuth` 字段，判断页面是否需要登录。
  - 检查 `meta.requiresAdmin` 字段，判断页面是否需要管理员权限。
