# 订单与支付系统文档

## 功能概述

订单与支付系统是交易闭环的核心，它管理着从用户下单、支付、到交易完成的整个流程。本系统支持从购物车或商品详情页直接创建订单，并提供了模拟支付、支付密码设置、以及订单历史追溯等功能。

### 核心功能
- **创建订单**：用户可以选择购物车中的商品或直接购买单个商品来创建订单。如果商品来自不同卖家，系统会创建多个子订单。
- **模拟支付**：用户需要输入预设的支付密码来完成支付。支付成功后，会扣除账户余额并更新订单状态。
- **支付密码管理**：首次支付的用户需要设置支付密码，之后也可以进行修改。
- **订单历史**：用户可以查看自己所有的历史订单，包括作为买家和作为卖家的订单，并追踪每个订单的状态（待支付、待发货、待收货、已完成等）。
- **订单状态流转**：系统支持 `PENDING_PAYMENT` -> `PROCESSING` -> `SHIPPED` -> `DELIVERED` -> `COMPLETED` 的完整订单生命周期管理。

## 数据库表结构

### order表（订单主表）
```sql
CREATE TABLE `order` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '订单ID',
  `user_id` int NOT NULL COMMENT '用户ID',
  `seller_id` int NOT NULL COMMENT '卖家ID',
  `total_price` decimal(10,2) NOT NULL COMMENT '总价',
  `status` varchar(50) NOT NULL COMMENT '订单状态',
  `shipping_address` varchar(255) DEFAULT NULL COMMENT '收货地址',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `user_id` (`user_id`),
  KEY `seller_id` (`seller_id`),
  CONSTRAINT `order_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`),
  CONSTRAINT `order_ibfk_2` FOREIGN KEY (`seller_id`) REFERENCES `user` (`id`)
);
```

### order_item表（订单项表）
```sql
CREATE TABLE `order_item` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '订单项ID',
  `order_id` int NOT NULL COMMENT '订单ID',
  `product_id` int NOT NULL COMMENT '商品ID',
  `quantity` int NOT NULL COMMENT '数量',
  `price` decimal(10,2) NOT NULL COMMENT '单价',
  PRIMARY KEY (`id`),
  KEY `order_id` (`order_id`),
  KEY `product_id` (`product_id`),
  CONSTRAINT `order_item_ibfk_1` FOREIGN KEY (`order_id`) REFERENCES `order` (`id`),
  CONSTRAINT `order_item_ibfk_2` FOREIGN KEY (`product_id`) REFERENCES `product` (`id`)
);
```

## 后端API接口

#### 1. 创建订单
`POST /api/orders`
- **Authorization**: `Bearer {token}`
- **Request Body**: `{ "productItems": [{ "productId": 1, "quantity": 2 }], "shippingAddress": "..." }`
- **Response**: `{ "success": true, "orderIds": [101, 102], "totalAmount": 199.8 }`

#### 2. 支付订单
`POST /api/orders/{orderId}/pay`
- **Authorization**: `Bearer {token}`
- **Request Body**: `{ "paymentPassword": "123456" }`
- **Response**: 成功或失败的消息。

#### 3. 获取用户订单历史
`GET /api/orders/history`
- **Authorization**: `Bearer {token}`
- **Query Params**: `as=buyer` 或 `as=seller`
- **Response**: 返回作为买家或卖家的订单列表。

#### 4. 获取单个订单详情
`GET /api/orders/{orderId}`
- **Authorization**: `Bearer {token}`
- **Response**: 指定ID的订单完整信息，包括订单项。

#### 5. 更新订单状态（如：发货、确认收货）
`PUT /api/orders/{orderId}/status`
- **Authorization**: `Bearer {token}`
- **Request Body**: `{ "status": "SHIPPED" }`
- **Response**: 成功或失败的消息。

#### 6. 设置/修改支付密码
`POST /api/users/set-payment-password`
- **Authorization**: `Bearer {token}`
- **Request Body**: `{ "password": "new-payment-password" }`
- **Response**: 成功或失败的消息。

## 前端视图与组件

- **PaymentView.vue**: 支付页面，用于确认订单信息和执行支付。
  - 路由: `/payment`
  - 从路由参数或Vuex中获取要结算的商品信息，展示订单总额和收货地址。
  - 包含一个支付密码输入的模态框。

- **OrderHistory.vue**: 订单历史页面。
  - 路由: `/order-history`
  - 提供“我买到的”和“我卖出的”两个标签页，分别调用API获取不同角色的订单列表。
  - 根据订单状态显示不同的操作按钮（如“去支付”、“确认收货”、“评价”）。

- **PaymentPasswordSetup.vue**: 支付密码设置页面。
  - 路由: `/setup-payment-password`
  - 在用户首次支付但未设置支付密码时，会跳转到此页面。

- **PaymentResult.vue**: 支付结果展示页面。
  - 路由: `/payment-result`
  - 显示支付成功或失败的状态。

## 订单创建与支付流程

1.  **发起创建**: 用户在 `CartView.vue` 点击“结算”或在 `ProductDetail.vue` 点击“立即购买”。
2.  **跳转支付页**: 前端将待结算的商品信息（`productId` 和 `quantity` 列表）通过路由参数或状态管理传递给 `PaymentView.vue`。
3.  **创建订单**: 在 `PaymentView.vue` 页面加载时或用户点击“提交订单”时，调用 `POST /api/orders` 接口。
4.  **后端处理**: `OrderService.java` 接收到请求后：
    -   根据商品列表中的 `sellerId` 对商品进行分组。
    -   为每个卖家创建一个主订单记录（`order` 表）。
    -   为每个主订单下的商品创建订单项记录（`order_item` 表）。
    -   将商品库存标记为“锁定”或减少库存。
    -   将购物车中对应的商品移除。
    -   所有操作在一个数据库事务中完成。
    -   返回新创建的所有订单ID和总金额。
5.  **发起支付**: 用户在支付页面输入支付密码，点击“确认支付”。
6.  **调用支付接口**: 前端调用 `POST /api/orders/{orderId}/pay` 接口（如果是多个订单，则需要循环调用或提供一个批量支付接口）。
7.  **后端验证与处理**: `PaymentService.java` 或 `OrderService.java`：
    -   验证支付密码是否正确。
    -   检查用户余额是否充足。
    -   扣除用户余额。
    -   将订单状态更新为 `PROCESSING`（待发货）。
    -   （在真实场景中，此处会与第三方支付网关交互）。
8.  **支付完成**: 接口返回成功后，前端跳转到 `PaymentResult.vue` 页面，显示成功信息，并引导用户查看订单或返回首页。

## 订单状态机

-   **PENDING_PAYMENT**: 待支付。订单已创建，等待用户付款。
-   **PROCESSING**: 处理中/待发货。用户已付款，等待卖家发货。
-   **SHIPPED**: 已发货。卖家已发货，等待买家收货。
-   **DELIVERED**: 已送达/待确认。买家已收到货，等待确认收货。
-   **COMPLETED**: 已完成。买家已确认收货，交易结束。
-   **CANCELLED**: 已取消。用户在付款前取消订单或支付超时。
-   **REFUNDED**: 已退款。发生了退款流程。
