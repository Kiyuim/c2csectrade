# 订单与支付系统文档

## 功能概述

订单与支付系统是C2C二手商品交易平台的核心组件，管理着从用户下单、支付到交易完成的全流程。本系统基于分布式架构设计，集成了Redis缓存、RabbitMQ消息队列等技术，支持从购物车批量下单或商品详情页直接购买，提供模拟支付、支付密码管理、订单追溯等完整功能。

### 核心功能

#### 1. 订单创建与管理
- **多渠道下单**：支持从购物车批量结算或商品详情页直接购买
- **多卖家订单拆分**：购物车商品来自不同卖家时，系统自动创建多个子订单
- **库存校验**：下单时实时校验商品库存，防止超卖
- **订单快照**：记录下单时的商品信息（价格、标题、图片等），避免商品修改影响历史订单
- **收货地址管理**：支持用户维护多个收货地址，下单时可选择

#### 2. 支付系统
- **模拟支付流程**：完整模拟真实支付场景，包含支付密码验证、余额扣减、支付结果反馈
- **支付密码管理**：首次支付需设置6位数字支付密码，支持密码修改和重置
- **余额系统**：用户账户余额管理，支持充值、消费、退款等操作
- **支付方式**：支持支付宝、微信支付、银行卡、余额支付等多种方式（模拟）
- **交易安全**：使用Redis分布式锁防止重复支付，确保交易一致性

#### 3. 订单中心（三个标签页）
- **我买到的**：
  - 查看作为买家的所有订单
  - 支持订单支付、取消订单、确认收货、评价等操作
  - 显示订单状态、物流信息、支付方式等详细信息
  - 支持按订单状态筛选（待支付、已支付、已发货、已完成）
  
- **我卖出的**：
  - 查看作为卖家的所有订单
  - 实时掌握销售情况和订单状态
  - 支持订单发货、查看买家信息等操作
  - 统计销售数据和收入信息
  
- **砍价活动**：
  - 管理所有参与的砍价活动
  - 查看砍价进度和助力记录
  - 支持砍价成功后直接下单购买
  - 实时显示砍价状态（进行中、成功、失败、已过期）

#### 4. 订单状态流转
系统支持完整的订单生命周期管理：
- **PENDING（待支付）**：订单创建成功，等待买家支付
- **PAID（已支付）**：买家完成支付，等待卖家发货
- **SHIPPED（已发货）**：卖家已发货，商品在途
- **DELIVERED（已送达）**：商品已送达，等待买家确认收货
- **COMPLETED（已完成）**：买家确认收货，交易完成
- **CANCELLED（已取消）**：订单已取消（未支付状态可取消）
- **REFUNDED（已退款）**：订单退款成功

#### 5. 消息通知
- **订单创建通知**：通过WebSocket实时推送给买卖双方
- **支付成功通知**：支付完成后立即通知买卖双方
- **发货提醒**：卖家发货后通知买家
- **收货提醒**：提醒买家确认收货
- **评价提醒**：交易完成后提醒买家评价

#### 6. 分布式特性
- **Redis缓存**：缓存热点订单数据，提升查询性能
- **分布式锁**：防止并发支付和库存超卖
- **消息队列**：异步处理订单创建、支付、发货等事件
- **事务保障**：使用Spring事务确保订单创建和库存扣减的原子性

## 数据库表结构

### order表（订单主表）
```sql
CREATE TABLE `order` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '订单ID',
  `user_id` int NOT NULL COMMENT '用户ID',
  `seller_id` int NOT NULL COMMENT '卖家ID',
  `total_price` decimal(10,2) NOT NULL COMMENT '总价',
  `status` varchar(50) NOT NULL COMMENT '订单状态',
  `shipping_address` varchar(255) DEFAULT NULL COMMENT '收货地址',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `user_id` (`user_id`),
  KEY `seller_id` (`seller_id`),
  CONSTRAINT `order_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`),
  CONSTRAINT `order_ibfk_2` FOREIGN KEY (`seller_id`) REFERENCES `user` (`id`)
);
```

### order_item表（订单项表）
```sql
CREATE TABLE `order_item` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '订单项ID',
  `order_id` int NOT NULL COMMENT '订单ID',
  `product_id` int NOT NULL COMMENT '商品ID',
  `quantity` int NOT NULL COMMENT '数量',
  `price` decimal(10,2) NOT NULL COMMENT '单价',
  PRIMARY KEY (`id`),
  KEY `order_id` (`order_id`),
  KEY `product_id` (`product_id`),
  CONSTRAINT `order_item_ibfk_1` FOREIGN KEY (`order_id`) REFERENCES `order` (`id`),
  CONSTRAINT `order_item_ibfk_2` FOREIGN KEY (`product_id`) REFERENCES `product` (`id`)
);
```

## 后端API接口

#### 1. 创建订单
`POST /api/orders`
- **Authorization**: `Bearer {token}`
- **Request Body**: `{ "productItems": [{ "productId": 1, "quantity": 2 }], "shippingAddress": "..." }`
- **Response**: `{ "success": true, "orderIds": [101, 102], "totalAmount": 199.8 }`

#### 2. 支付订单
`POST /api/orders/{orderId}/pay`
- **Authorization**: `Bearer {token}`
- **Request Body**: `{ "paymentPassword": "123456" }`
- **Response**: 成功或失败的消息。

#### 3. 获取买家订单列表
`GET /api/orders`
- **Authorization**: `Bearer {token}`
- **Response**: 返回当前用户作为买家的所有订单列表。

#### 4. 获取卖家订单列表
`GET /api/orders/seller`
- **Authorization**: `Bearer {token}`
- **Response**: 返回当前用户作为卖家的所有订单列表（即买家购买了该用户发布的商品）。

#### 5. 获取单个订单详情
`GET /api/orders/{orderId}`
- **Authorization**: `Bearer {token}`
- **Response**: 指定ID的订单完整信息，包括订单项。

#### 6. 确认收货
`POST /api/orders/{orderId}/confirm`
- **Authorization**: `Bearer {token}`
- **Response**: 成功或失败的消息。

#### 7. 取消订单
`POST /api/orders/{orderId}/cancel`
- **Authorization**: `Bearer {token}`
- **Response**: 成功或失败的消息。

#### 8. 设置/修改支付密码
`POST /api/users/set-payment-password`
- **Authorization**: `Bearer {token}`
- **Request Body**: `{ "password": "new-payment-password" }`
- **Response**: 成功或失败的消息。

## 前端视图与组件

- **PaymentView.vue**: 支付页面，用于确认订单信息和执行支付。
  - 路由: `/payment`
  - 从路由参数或Vuex中获取要结算的商品信息，展示订单总额和收货地址。
  - 包含一个支付密码输入的模态框。

- **OrderHistory.vue**: 订单中心页面。
  - 路由: `/order-history`
  - 提供三个标签页：
    - **📦 我买到的**：展示作为买家的订单列表，根据订单状态显示不同的操作按钮（去支付、取消订单、确认收货、评价订单）
    - **💰 我卖出的**：展示作为卖家的订单列表，显示买家信息和订单状态（等待买家付款、等待买家确认收货、交易完成）
    - **🔪 砍价活动**：展示用户参与的所有砍价活动，包括进度、助力人数、剩余时间等信息
  - 支持订单过期检测，自动标记超时未支付的订单为"已过期"状态。

- **PaymentPasswordSetup.vue**: 支付密码设置页面。
  - 路由: `/setup-payment-password`
  - 在用户首次支付但未设置支付密码时，会跳转到此页面。

- **PaymentResult.vue**: 支付结果展示页面。
  - 路由: `/payment-result`
  - 显示支付成功或失败的状态。

## 订单创建与支付流程

1.  **发起创建**: 用户在 `CartView.vue` 点击“结算”或在 `ProductDetail.vue` 点击“立即购买”。
2.  **跳转支付页**: 前端将待结算的商品信息（`productId` 和 `quantity` 列表）通过路由参数或状态管理传递给 `PaymentView.vue`。
3.  **创建订单**: 在 `PaymentView.vue` 页面加载时或用户点击“提交订单”时，调用 `POST /api/orders` 接口。
4.  **后端处理**: `OrderService.java` 接收到请求后：
    -   根据商品列表中的 `sellerId` 对商品进行分组。
    -   为每个卖家创建一个主订单记录（`order` 表）。
    -   为每个主订单下的商品创建订单项记录（`order_item` 表）。
    -   将商品库存标记为“锁定”或减少库存。
    -   将购物车中对应的商品移除。
    -   所有操作在一个数据库事务中完成。
    -   返回新创建的所有订单ID和总金额。
5.  **发起支付**: 用户在支付页面输入支付密码，点击“确认支付”。
6.  **调用支付接口**: 前端调用 `POST /api/orders/{orderId}/pay` 接口（如果是多个订单，则需要循环调用或提供一个批量支付接口）。
7.  **后端验证与处理**: `PaymentService.java` 或 `OrderService.java`：
    -   验证支付密码是否正确。
    -   检查用户余额是否充足。
    -   扣除用户余额。
    -   将订单状态更新为 `PROCESSING`（待发货）。
    -   （在真实场景中，此处会与第三方支付网关交互）。
8.  **支付完成**: 接口返回成功后，前端跳转到 `PaymentResult.vue` 页面，显示成功信息，并引导用户查看订单或返回首页。

## 订单状态机

-   **PENDING_PAYMENT**: 待支付。订单已创建，等待用户付款。
-   **PROCESSING**: 处理中/待发货。用户已付款，等待卖家发货。
-   **SHIPPED**: 已发货。卖家已发货，等待买家收货。
-   **DELIVERED**: 已送达/待确认。买家已收到货，等待确认收货。
-   **COMPLETED**: 已完成。买家已确认收货，交易结束。
-   **CANCELLED**: 已取消。用户在付款前取消订单或支付超时。
-   **REFUNDED**: 已退款。发生了退款流程。
