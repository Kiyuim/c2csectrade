# 商品发布与管理系统文档

## 功能概述

本系统为用户提供了完整的商品生命周期管理功能，从发布新商品到后续的编辑、上架/下架和删除。系统还支持富文本描述和多图片上传，并将静态资源存储在MinIO对象存储中。

### 核心功能
- **发布商品**：用户可以通过表单发布新商品，包括填写商品名称、描述、价格、分类、校区等信息。
- **图片上传**：支持上传多张商品图片，图片会上传到MinIO服务器并返回URL。
- **富文本描述**：商品描述支持富文本格式，允许用户自定义样式、插入图片等。
- **商品管理**：用户可以在个人中心管理自己发布的商品，包括编辑商品信息、上架或下架商品。
- **商品详情**：任何人都可以查看商品的详细信息，包括所有图片、描述、价格、卖家信息等。
- **商品搜索与分类**：主页支持按关键字搜索商品，并可以按分类和校区进行筛选。

## 数据库表结构

### product表（商品表）
```sql
CREATE TABLE `product` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '商品ID',
  `user_id` int NOT NULL COMMENT '用户ID',
  `title` varchar(100) NOT NULL COMMENT '商品标题',
  `description` text COMMENT '商品描述',
  `price` decimal(10,2) NOT NULL COMMENT '价格',
  `category_id` int DEFAULT NULL COMMENT '分类ID',
  `campus_id` int DEFAULT NULL COMMENT '校区ID',
  `status` varchar(20) DEFAULT 'AVAILABLE' COMMENT '商品状态 (AVAILABLE, SOLD, REMOVED)',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `user_id` (`user_id`),
  CONSTRAINT `product_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`)
);
```

### product_media表（商品媒体表）
```sql
CREATE TABLE `product_media` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '媒体ID',
  `product_id` int NOT NULL COMMENT '商品ID',
  `media_url` varchar(255) NOT NULL COMMENT '媒体文件URL',
  `media_type` varchar(20) DEFAULT 'IMAGE' COMMENT '媒体类型 (IMAGE, VIDEO)',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `product_id` (`product_id`),
  CONSTRAINT `product_media_ibfk_1` FOREIGN KEY (`product_id`) REFERENCES `product` (`id`)
);
```

## 后端API接口

#### 1. 发布新商品
`POST /api/products`
- **Authorization**: `Bearer {token}`
- **Request Body**: 包含商品信息的JSON对象，如 `{ "title": "...", "price": 99.9, ... }`。
- **Response**: 成功创建的商品信息。

#### 2. 上传商品图片
`POST /api/products/upload`
- **Authorization**: `Bearer {token}`
- **Request**: `multipart/form-data` 文件上传请求。
- **Response**: `{ "success": true, "url": "minio-image-url" }`。

#### 3. 获取所有商品（支持分页和筛选）
`GET /api/products`
- **Query Params**: `page`, `size`, `sort`, `categoryId`, `campusId`, `keyword`。
- **Response**: 分页后的商品列表。

#### 4. 获取单个商品详情
`GET /api/products/{productId}`
- **Response**: 指定ID的商品完整信息，包括卖家信息和媒体文件列表。

#### 5. 更新商品信息
`PUT /api/products/{productId}`
- **Authorization**: `Bearer {token}`
- **Request Body**: 需要更新的商品字段。
- **Response**: 更新后的商品信息。

#### 6. 删除商品
`DELETE /api/products/{productId}`
- **Authorization**: `Bearer {token}`
- **Response**: 成功或失败的消息。

#### 7. 获取用户发布的商品
`GET /api/users/{userId}/products`
- **Response**: 指定用户发布的所有商品列表。

## 前端视图与组件

- **ProductCreate.vue**: 商品发布和编辑页面。
  - 路由: `/product/create` (发布), `/product/edit/:id` (编辑)。
  - 集成了文件上传组件和富文本编辑器。

- **ProductManageView.vue**: 用户个人商品管理页面。
  - 路由: `/manage-products`。
  - 以列表形式展示用户发布的商品，提供编辑、上架/下架、删除等操作入口。

- **ProductDetail.vue**: 商品详情页。
  - 路由: `/product/:id`。
  - 展示商品的所有信息，包括图片轮播、富文本内容、价格、卖家信用等。

- **HomeView.vue**: 应用首页。
  - 路由: `/`。
  - 以瀑布流形式展示所有“在售”商品，并提供搜索和分类筛选功能。

## 核心功能实现

### 文件上传流程 (MinIO)
1. **前端**: 用户在 `ProductCreate.vue` 页面选择图片文件。
2. **前端**: 调用 `POST /api/products/upload` 接口，将图片文件以 `multipart/form-data` 格式发送到后端。
3. **后端 (ProductController.java)**: 接收到文件后，调用 `MinioService.java`。
4. **后端 (MinioService.java)**: 
   - 生成一个唯一的文件名（通常使用UUID）。
   - 使用MinIO Java客户端库的 `putObject` 方法将文件流上传到指定的存储桶（Bucket）中。
   - 返回文件的公共访问URL。
5. **前端**: 接收到URL后，将其添加到商品媒体文件列表中，并在页面上预览。
6. **前端**: 用户提交整个商品表单时，包含所有图片URL的列表会随商品信息一同发送到 `POST /api/products` 接口。
7. **后端 (ProductService.java)**: 
   - 首先在 `product` 表中创建一条记录。
   - 然后遍历媒体URL列表，在 `product_media` 表中为该商品创建多条媒体记录。
   - 整个过程在一个数据库事务中完成，保证数据一致性。

### 富文本编辑器
- 前端使用了第三方Vue富文本编辑器组件（如 `vue-quill-editor` 或类似组件）。
- 编辑器生成的内容是HTML字符串，后端直接将其存储在 `product` 表的 `description` 字段中。
- 在 `ProductDetail.vue` 页面，使用 `v-html` 指令来渲染这段HTML，从而展示格式化的文本。
